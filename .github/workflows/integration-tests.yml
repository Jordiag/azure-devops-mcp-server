name: Integration Tests

on:
  workflow_run:
    workflows: ["Build on main"]
    types:
      - completed

jobs:
  integration-tests:
    runs-on: windows-latest

    env:
      buildPlatform: 'Any CPU'
      buildConfiguration: 'Release'
      solution: 'Dotnet.AzureDevOps.sln'
      sonarProjectKey: 'Chanlabs_Dotnet.AzureDevOps'
      sonarOrganization: 'chanlabs-1'
      AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
      AZURE_DEVOPS_PIPELINE_ID: ${{ secrets.AZURE_DEVOPS_PIPELINE_ID }}
      AZURE_DEVOPS_PROJECT_ID: ${{ secrets.AZURE_DEVOPS_PROJECT_ID }}
      AZURE_DEVOPS_REPO_ID: ${{ secrets.AZURE_DEVOPS_REPO_ID }}
      AZURE_DEVOPS_REPOSITORY_ID: ${{ secrets.AZURE_DEVOPS_REPOSITORY_ID }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'  # or the version used in your solution

      - name: Install NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet packages
        run: nuget restore "${{ env.solution }}"

      - name: SonarCloud - Begin Analysis
        uses: SonarSource/sonarcloud-github-action@master
        with:
          args: >
            -Dsonar.projectKey=Chanlabs_Dotnet.AzureDevOps
            -Dsonar.organization=chanlabs-1
            -Dsonar.projectName=Dotnet.AzureDevOps
            -Dsonar.projectVersion=0.1.0
            -Dsonar.cs.vscoveragexml.reportsPaths=${{ runner.temp }}/**/*.coveragexml
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.1
      
      - name: Build with MSBuild
        run: msbuild Dotnet.AzureDevOps.sln /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="${{ github.workspace }}/artifacts" /p:Platform="Any CPU" /p:Configuration="Release"


      - name: Run Tests with Coverage
        run: |
          dotnet test ${{ env.solution }} \
            --configuration "${{ env.buildConfiguration }}" \
            --settings "${{ github.workspace }}/.runsettings" \
            --collect:"Code Coverage" \
            --no-build
        continue-on-error: true

      - name: Install SonarScanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner
      
      - name: Add .NET tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
      
      - name: End SonarCloud Analysis
        run: dotnet-sonarscanner end
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}


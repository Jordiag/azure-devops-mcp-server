on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'
      - 'README.*.md'
      - '**/README.md'
      - '**/README.*.md'

  pull_request:
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'
      - 'README.*.md'
      - '**/README.md'
      - '**/README.*.md'

  workflow_dispatch:

jobs:
  integration-tests:
    runs-on: windows-latest
    env:
      buildPlatform: 'Any CPU'
      buildConfiguration: 'Release'
      solution: 'Dotnet.AzureDevOps.sln'
      sonarProjectKey: 'Jordiag_azure-devops-mcp-server'
      sonarOrganization: 'jordiag-mozcode'
      AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
      AZURE_DEVOPS_PIPELINE_ID: ${{ secrets.AZURE_DEVOPS_PIPELINE_ID }}
      AZURE_DEVOPS_PROJECT_ID: ${{ secrets.AZURE_DEVOPS_PROJECT_ID }}
      AZURE_DEVOPS_REPO_ID: ${{ secrets.AZURE_DEVOPS_REPO_ID }}
      AZURE_DEVOPS_REPOSITORY_ID: ${{ secrets.AZURE_DEVOPS_REPOSITORY_ID }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT }}
      AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
      AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
      AZURE_DEVOPS_BOT_USER_EMAIL: ${{ vars.AZURE_DEVOPS_BOT_USER_EMAIL }}
      AZURE_DEVOPS_BUILD_BRANCH: ${{ vars.AZURE_DEVOPS_BUILD_BRANCH }}
      AZURE_DEVOPS_COMMIT_SHA: ${{ vars.AZURE_DEVOPS_COMMIT_SHA }}
      AZURE_DEVOPS_MAIN_BRANCH_NAME: ${{ vars.AZURE_DEVOPS_MAIN_BRANCH_NAME }}
      AZURE_DEVOPS_ORG_URL: ${{ vars.AZURE_DEVOPS_ORG_URL }}
      AZURE_DEVOPS_SEARCH_ORG_URL: ${{ vars.AZURE_DEVOPS_SEARCH_ORG_URL }}
      AZURE_DEVOPS_ORG:  ${{ vars.AZURE_DEVOPS_ORG }}
      AZURE_DEVOPS_PROJECT_NAME: ${{ vars.AZURE_DEVOPS_PROJECT_NAME }}
      AZURE_DEVOPS_REPO_NAME: ${{ vars.AZURE_DEVOPS_REPO_NAME }}
      AZURE_DEVOPS_SRC_BRANCH: ${{ vars.AZURE_DEVOPS_SRC_BRANCH }}
      AZURE_DEVOPS_TARGET_BRANCH: ${{ vars.AZURE_DEVOPS_TARGET_BRANCH }}
      MCP_SERVER_URL: ${{ vars.MCP_SERVER_URL }}
      OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
      USE_AZURE_OPENAI: ${{ vars.USE_AZURE_OPENAI }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for SonarCloud analysis
          fetch-tags: true

      - name: Determine numeric version from tag
        id: ver
        shell: bash
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          TAG=${TAG#v}; TAG=${TAG#V}
          echo "Original tag: $TAG"
      
          # Keep only numbers/dots, normalise
          NUMERIC=$(echo "$TAG" | sed 's/[^0-9.]/./g' | sed -E 's/\.+/./g; s/^\.//; s/\.$//')
          IFS=. read -r a b c _ <<< "$NUMERIC"
          a=${a:-0}; b=${b:-0}; c=${c:-0}
      
          BUILD=${GITHUB_RUN_NUMBER}
          FOUR="$a.$b.$c.$BUILD"
          SHORTSHA="${GITHUB_SHA::7}"
          INFO="$TAG.$BUILD+$SHORTSHA"
      
          echo "Four-part (Assembly/File): $FOUR"
          echo "Informational: $INFO"
      
          {
            echo "tag=$TAG"
            echo "four=$FOUR"
            echo "informational=$INFO"
          } >> "$GITHUB_OUTPUT"


      - name: Install NuGet
        uses: NuGet/setup-nuget@v1

      - name: Install SonarCloud Scanner for .NET
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Install Coverage Tool
        run: dotnet tool install --global dotnet-coverage

      - name: Set cache date
        id: cache-date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ steps.cache-date.outputs.date }}
          restore-keys: |
            nuget-${{ runner.os }}-
            nuget-

      - name: Restore NuGet packages
        run: nuget restore "${{ env.solution }}"
      
      - name: Set Sonar PR Analysis Parameters (if pull_request)
        if: github.event_name == 'pull_request'
        env:
            PR_NUMBER: ${{ github.event.pull_request.number }}
            PR_BRANCH_RAW: ${{ github.head_ref }}
            PR_BASE_RAW: ${{ github.base_ref }}
        run: |
          # Sanitize branch/base names: keep alnum . _ / -
          $prBranch = "$env:PR_BRANCH_RAW" -replace '[^A-Za-z0-9._/\-]', ''
          $prBase   = "$env:PR_BASE_RAW"   -replace '[^A-Za-z0-9._/\-]', ''
          if (-not $prBranch) { Write-Error "Sanitized PR branch name empty (was '$env:PR_BRANCH_RAW')."; exit 1 }
          if (-not $prBase) { Write-Error "Sanitized PR base name empty (was '$env:PR_BASE_RAW')."; exit 1 }

          dotnet sonarscanner begin `
            /k:"${{ env.sonarProjectKey }}" `
            /o:"${{ env.sonarOrganization }}" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.host.url="https://sonarcloud.io" `
            /d:sonar.cs.vscoveragexml.reportsPaths="coverage.xml" `
            /d:sonar.dotnet.excludeTestProjects=true `
            /d:sonar.pullrequest.key="$env:PR_NUMBER" `
            /d:sonar.pullrequest.branch="$prBranch" `
            /d:sonar.pullrequest.base="$prBase"
        shell: pwsh

    # -- Sonar Begin (Non-PR: workflow_run or manual) --
      - name: Begin SonarCloud Analysis (Non-PR)
        if: github.event_name != 'pull_request'
        run: |
          dotnet sonarscanner begin `
            /k:"${{ env.sonarProjectKey }}" `
            /o:"${{ env.sonarOrganization }}" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.host.url="https://sonarcloud.io" `
            /d:sonar.cs.vscoveragexml.reportsPaths="coverage.xml" `
            /d:sonar.dotnet.excludeTestProjects=true
            
      - name: Build with Dotnet
        shell: pwsh
        run: >
          dotnet build "${{ env.solution }}" -c "${{ env.buildConfiguration }}" --no-restore
          -p:Version=${{ steps.ver.outputs.tag }}
          -p:AssemblyVersion=${{ steps.ver.outputs.four }}
          -p:FileVersion=${{ steps.ver.outputs.four }}
          "-p:InformationalVersion=${{ steps.ver.outputs.informational }}"

      - name: Run Tests with Coverage
        run: |
          dotnet test "${{ env.solution }}" `
            -c "${{ env.buildConfiguration }}" `
            --filter "TestType!=End2End" `
            --no-restore --no-build `
            --settings "${{ github.workspace }}/.runsettings" `
            --collect:"Code Coverage" `
            --results-directory ./TestResults/ `
            --logger "trx"
        shell: pwsh
        continue-on-error: false

      - name: Convert Coverage to XML
        run: |
          dotnet-coverage merge ./TestResults/**/*.coverage --output coverage.xml --output-format xml
        shell: pwsh
        continue-on-error: false

      - name: End SonarCloud Analysis
        run: dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}